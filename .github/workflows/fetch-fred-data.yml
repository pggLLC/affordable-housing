name: Fetch FRED Data

on:
  schedule:
    - cron: '0 6 * * *'   # Runs daily at 6am UTC
  workflow_dispatch:        # Also allows manual trigger from GitHub UI

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch FRED series and save as JSON
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          mkdir -p data

          fetch_series() {
            local id=$1
            curl -sf \
              "https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${FRED_API_KEY}&file_type=json&sort_order=asc&observation_start=2019-01-01&limit=120" \
              | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          obs = [{'date': o['date'], 'value': o['value']} for o in d.get('observations', []) if o.get('value') not in ('.', None, '')]
          print(json.dumps(obs))
          "
          }

          # Fetch all series and write to data/fred-data.json
          python3 - <<'PYEOF'
          import subprocess, json, sys

          SERIES = {
            # Construction
            "WPUFD49207":    "PPI: Inputs to construction",
            "WPUSI012011":   "PPI: Lumber & wood products",
            "WPUFD4":        "PPI: Construction materials",
            "PCU236115236115": "PPI: New multifamily construction",
            "CES2000000008": "Construction Avg Hourly Earnings",
            "ECIALLCIV":     "Employment Cost Index",
            # Housing
            "HOUST":         "Housing Starts",
            "PERMIT":        "Building Permits",
            "CSUSHPISA":     "Case-Shiller Home Price Index",
            "MSPUS":         "Median Sales Price of Houses",
            "RHORUSQ156N":   "Homeownership Rate",
            "RRVRUSQ156N":   "Rental Vacancy Rate",
            # Finance
            "DGS10":         "10-Year Treasury Yield",
            "DGS2":          "2-Year Treasury Yield",
            "DFF":           "Effective Fed Funds Rate",
            "MORTGAGE30US":  "30-Year Fixed Mortgage Rate",
            "BAA10Y":        "Baa-10Y Treasury Spread",
            "T10Y2Y":        "Yield Curve (10Y-2Y)",
            # Labor
            "UNRATE":        "Unemployment Rate",
            "PAYEMS":        "Nonfarm Payrolls",
            "CIVPART":       "Labor Force Participation",
            "CES0500000003": "Average Hourly Earnings",
            "JTSJOL":        "Job Openings",
            "ICSA":          "Initial Jobless Claims",
            # Commodities
            "WPU10170503":   "Steel Reinforcing Bar",
            "PCU33142033142012": "Copper Wire & Cable",
            "PCU32121132121103": "Softwood Lumber",
            "WPU0811":       "Framing Lumber",
            "WPU0812":       "Plywood Sheathing",
            "PCU32731327313": "Concrete Products",
            "WPU13310101":   "Portland Cement",
            "PCU32732032732021": "Ready-Mix Concrete",
            "PCU32742032742012": "Gypsum Drywall",
            "WPU057303":     "Diesel Fuel",
            "CES2000000003": "Construction Avg Hourly Wage",
          }

          import os, urllib.request
          api_key = os.environ['FRED_API_KEY']
          result = {}
          for series_id, name in SERIES.items():
              url = (f"https://api.stlouisfed.org/fred/series/observations"
                     f"?series_id={series_id}&api_key={api_key}"
                     f"&file_type=json&sort_order=asc&observation_start=2019-01-01&limit=120")
              try:
                  with urllib.request.urlopen(url) as r:
                      d = json.loads(r.read())
                  obs = [{"date": o["date"], "value": o["value"]}
                         for o in d.get("observations", [])
                         if o.get("value") not in (".", None, "")]
                  result[series_id] = {"name": name, "observations": obs}
                  print(f"  ✓ {series_id} ({len(obs)} obs)", flush=True)
              except Exception as e:
                  print(f"  ✗ {series_id}: {e}", flush=True)
                  result[series_id] = {"name": name, "observations": []}

          import datetime
          output = {
              "updated": datetime.datetime.utcnow().isoformat() + "Z",
              "series": result
          }
          with open("data/fred-data.json", "w") as f:
              json.dump(output, f)
          print(f"\nWrote data/fred-data.json ({len(result)} series)")
          PYEOF

      - name: Commit and push updated data
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/fred-data.json
          git diff --cached --quiet || git commit -m "chore: update FRED data $(date -u +'%Y-%m-%d')"
          git push
