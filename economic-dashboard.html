<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Economic Dashboard | Affordable Housing</title>
  <meta name="description" content="Real-time economic indicators from FRED affecting affordable housing development."/>
  <style>
    :root{color-scheme: light dark;}
    :root{
      --bg-l:#f8fafc; --card-l:#ffffff; --text-l:#0f172a; --muted-l:#475569; --border-l:rgba(15,23,42,.14);
      --bg-d:#0b1220; --card-d:#0f172a; --text-d:#e5e7eb; --muted-d:#a1a1aa; --border-d:rgba(255,255,255,.12);
      --accent:#2563eb; --good:#16a34a; --warn:#d97706; --bad:#dc2626; --focus:#fbbf24;
      --shadow:0 14px 30px rgba(0,0,0,.12);
      --radius:18px;
    }
    @media (prefers-color-scheme: light){:root{--bg:var(--bg-l);--card:var(--card-l);--text:var(--text-l);--muted:var(--muted-l);--border:var(--border-l);}}
    @media (prefers-color-scheme: dark){:root{--bg:var(--bg-d);--card:var(--card-d);--text:var(--text-d);--muted:var(--muted-d);--border:var(--border-d);}}

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}
    a:focus-visible{outline:3px solid var(--focus);outline-offset:3px;border-radius:10px}

    .container{max-width:1160px;margin:0 auto;padding:22px 16px 60px}
    .nav{
      position:sticky;top:0;z-index:50;
      backdrop-filter:saturate(180%) blur(10px);
      background:color-mix(in srgb,var(--bg) 80%, transparent);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{max-width:1160px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .links{display:flex;flex-wrap:wrap;gap:10px}
    .links a{color:var(--text);text-decoration:none;padding:8px 10px;border-radius:12px}
    .links a:hover{background:color-mix(in srgb,var(--card) 85%, transparent);border:1px solid var(--border);padding:7px 9px}

    .hero{margin-top:14px}
    .kicker{font-weight:800;letter-spacing:.05em;text-transform:uppercase;color:var(--muted);font-size:.82rem}
    h1{margin:8px 0 10px;font-size:clamp(1.8rem,3.1vw,2.6rem);line-height:1.1}
    .sub{color:var(--muted);max-width:78ch;margin:0}

    .toolbar{margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .control{padding:12px 14px;display:flex;gap:10px;align-items:center}
    .control label{font-weight:700}
    .control input{
      width:min(380px,70vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--card) 90%, transparent);
      color:var(--text);
    }
    .btn{
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--border);
      background:color-mix(in srgb,var(--card) 92%, transparent);
      color:var(--text);
      padding:10px 12px;
      font-weight:800;
    }
    .btn.primary{background:var(--accent);border-color:color-mix(in srgb,var(--accent) 70%, black);color:white}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{padding:12px 14px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:color-mix(in srgb,var(--card) 92%, transparent);
      color:var(--muted);font-weight:700;font-size:.9rem
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px}
    .stat{grid-column:span 12;padding:14px}
    .stat .num{font-size:1.6rem;font-weight:900;margin:0}
    .stat .lbl{margin:4px 0 0;color:var(--muted)}
    @media (min-width:860px){.stat{grid-column:span 3}}

    details{margin-top:14px}
    details > summary{
      list-style:none;cursor:pointer;
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      font-weight:900;
    }
    details > summary::-webkit-details-marker{display:none}
    .section-body{padding:0 16px 16px}
    .section-desc{color:var(--muted);margin:0 0 12px}

    .metric-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .metric{grid-column:span 12;padding:14px}
    @media (min-width:860px){.metric{grid-column:span 4}}
    .metric h3{margin:0 0 8px;font-size:1rem}
    .metric .value{font-size:1.6rem;font-weight:950;margin:0}
    .metric .meta{margin:6px 0 0;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .delta{font-weight:900}
    .delta.up{color:var(--good)}
    .delta.down{color:var(--bad)}
    .delta.flat{color:var(--muted)}
    .chart-wrap{margin-top:10px;border-top:1px solid var(--border);padding-top:10px}
    canvas{width:100% !important;height:180px !important}

    .note{margin-top:18px;color:var(--muted);font-size:.95rem}
    .small{font-size:.9rem}
    .err{color:var(--bad);font-weight:800}
  </style>

  <!-- Chart.js (client-side) -->
  <script src="js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Navigation (mimics HousingMetrics style) -->
  <header class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span>HousingMetrics</div>
      <nav class="links" aria-label="Primary">
        <a href="index.html">LIHTC Data</a>
        <a href="economic-dashboard.html" aria-current="page">Dashboard</a>
        <a href="industry-news.html">Industry News</a>
        <a href="housing-insights.html">Insights</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="kicker">Real-time • FRED</div>
      <h1>Economic Dashboard</h1>
      <p class="sub">
        Live economic indicators from the Federal Reserve Economic Data (FRED) that influence affordable housing development:
        construction costs, interest rates, labor, and housing market conditions.
      </p>

      <div class="toolbar">
        </div>
      </div>

      <div class="grid">
        <div class="card stat">
          <p class="num" id="statCpi">—</p>
          <p class="lbl">Inflation (CPI YoY)</p>
        </div>
        <div class="card stat">
          <p class="num" id="statUnemp">—</p>
          <p class="lbl">Unemployment rate</p>
        </div>
        <div class="card stat">
          <p class="num" id="stat10y">—</p>
          <p class="lbl">10-Year Treasury</p>
        </div>
        <div class="card stat">
          <p class="num" id="statStarts">—</p>
          <p class="lbl">Housing starts (SAAR)</p>
        </div>
      </div>

      <p class="note">
        Data source: <a href="https://fred.stlouisfed.org" target="_blank" rel="noopener">FRED</a>, Federal Reserve Bank of St. Louis.
        If charts don’t load, confirm your key is valid and check browser console for errors.
      </p>
    </section>

    <!-- Collapsible sections (Nixvir-like: metric cards with inline charts) -->
    <details open class="card">
      <summary>
        Construction Costs
        <span class="pill small">6 indicators</span>
      </summary>
      <div class="section-body">
        <p class="section-desc">Producer price indices and cost proxies that impact per-unit construction budgets and feasibility.</p>
        <div class="metric-grid" id="sec-construction"></div>
      </div>
    </details>

    <details class="card">
      <summary>
        Housing Market
        <span class="pill small">6 indicators</span>
      </summary>
      <div class="section-body">
        <p class="section-desc">Starts, permits, prices, and affordability signals that shape pipeline and underwriting assumptions.</p>
        <div class="metric-grid" id="sec-housing"></div>
      </div>
    </details>

    <details class="card">
      <summary>
        Financial & Interest Rates
        <span class="pill small">6 indicators</span>
      </summary>
      <div class="section-body">
        <p class="section-desc">Rates and spreads that move equity pricing, permanent debt terms, and bond execution costs.</p>
        <div class="metric-grid" id="sec-finance"></div>
      </div>
    </details>

    <details class="card">
      <summary>
        Labor Market
        <span class="pill small">6 indicators</span>
      </summary>
      <div class="section-body">
        <p class="section-desc">Employment, earnings, and labor supply indicators relevant to labor cost pressure and demand.</p>
        <div class="metric-grid" id="sec-labor"></div>
      </div>
    </details>

    <p class="note small">
      Implementation notes: FRED data is fetched client-side via the FRED API “observations” endpoint.
      Some series update monthly or quarterly; charts show the most recent 5 years (or max available if shorter).
    </p>
  </main>

<script>
(() => {
  const CONFIG_KEY = (window.APP_CONFIG && window.APP_CONFIG.FRED_API_KEY) ? window.APP_CONFIG.FRED_API_KEY : "";

  // Keep your "desired indicators" (24) but render them nixvir-style.
  const INDICATORS = [
    // Construction (6)
    {section:"construction", id:"WPUFD49207", title:"PPI: Inputs to construction", units:"index", fmt:"index"},
    {section:"construction", id:"WPUSI012011", title:"PPI: Lumber & wood products", units:"index", fmt:"index"},
    {section:"construction", id:"WPUFD4", title:"PPI: Construction materials", units:"index", fmt:"index"},
    {section:"construction", id:"PCU236115236115", title:"PPI: New multifamily construction", units:"index", fmt:"index"},
    {section:"construction", id:"CES2000000008", title:"Construction Avg Hourly Earnings", units:"$/hr", fmt:"usd"},
    {section:"construction", id:"ECIALLCIV", title:"Employment Cost Index (Total comp)", units:"index", fmt:"index"},

    // Housing (6)
    {section:"housing", id:"HOUST", title:"Housing Starts (SAAR)", units:"thousands", fmt:"int"},
    {section:"housing", id:"PERMIT", title:"Building Permits (SAAR)", units:"thousands", fmt:"int"},
    {section:"housing", id:"CSUSHPISA", title:"Case-Shiller Home Price Index", units:"index", fmt:"index"},
    {section:"housing", id:"MSPUS", title:"Median Sales Price of Houses", units:"$", fmt:"usd"},
    {section:"housing", id:"RHORUSQ156N", title:"Homeownership Rate", units:"%", fmt:"pct"},
    {section:"housing", id:"RRVRUSQ156N", title:"Rental Vacancy Rate", units:"%", fmt:"pct"},

    // Finance (6)
    {section:"finance", id:"DGS10", title:"10-Year Treasury Yield", units:"%", fmt:"pct"},
    {section:"finance", id:"DGS2", title:"2-Year Treasury Yield", units:"%", fmt:"pct"},
    {section:"finance", id:"DFF", title:"Effective Fed Funds Rate", units:"%", fmt:"pct"},
    {section:"finance", id:"MORTGAGE30US", title:"30-Year Fixed Mortgage Rate", units:"%", fmt:"pct"},
    {section:"finance", id:"BAA10Y", title:"Moody’s Baa - 10Y Treasury Spread", units:"pts", fmt:"pct"},
    {section:"finance", id:"T10Y2Y", title:"Yield Curve (10Y-2Y)", units:"pts", fmt:"pct"},

    // Labor (6)
    {section:"labor", id:"UNRATE", title:"Unemployment Rate", units:"%", fmt:"pct"},
    {section:"labor", id:"PAYEMS", title:"Nonfarm Payrolls", units:"thousands", fmt:"int"},
    {section:"labor", id:"CIVPART", title:"Labor Force Participation", units:"%", fmt:"pct"},
    {section:"labor", id:"CES0500000003", title:"Average Hourly Earnings", units:"$", fmt:"usd"},
    {section:"labor", id:"JTSJOL", title:"Job Openings (JOLTS)", units:"thousands", fmt:"int"},
    {section:"labor", id:"ICSA", title:"Initial Jobless Claims", units:"count", fmt:"int"}
  ];

  const els = {
    
    
    
    conn: document.getElementById("conn"),
    refresh: document.getElementById("refresh"),
    lastUpdated: document.getElementById("lastUpdated"),
    count: document.getElementById("count"),
    statCpi: document.getElementById("statCpi"),
    statUnemp: document.getElementById("statUnemp"),
    stat10y: document.getElementById("stat10y"),
    statStarts: document.getElementById("statStarts"),
    sec: {
      construction: document.getElementById("sec-construction"),
      housing: document.getElementById("sec-housing"),
      finance: document.getElementById("sec-finance"),
      labor: document.getElementById("sec-labor"),
    }
  };

  els.count.textContent = String(INDICATORS.length);

  function getKey(){ return CONFIG_KEY || ""; }
    
  function fmtValue(v, fmt){
    const n = Number(v);
    if (!isFinite(n)) return "—";
    if (fmt === "pct") return n.toFixed(2).replace(/\.00$/,"") + "%";
    if (fmt === "usd") {
      // show no decimals for large numbers, two decimals for small
      const abs = Math.abs(n);
      const decimals = abs >= 100 ? 0 : 2;
      return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:decimals});
    }
    if (fmt === "int") return Math.round(n).toLocaleString();
    return n.toLocaleString(undefined,{maximumFractionDigits:2});
  }

  function deltaClass(d){
    if (!isFinite(d)) return "flat";
    if (d > 0) return "up";
    if (d < 0) return "down";
    return "flat";
  }
  function arrow(d){
    if (!isFinite(d)) return "→";
    if (d > 0) return "↑";
    if (d < 0) return "↓";
    return "→";
  }

  async function fetchFRED(seriesId, apiKey, limit=84){
    // 84 points ~ 7 years monthly; enough for charts even if quarterly/daily
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 12000);

    const url = new URL("https://api.stlouisfed.org/fred/series/observations");
    url.searchParams.set("series_id", seriesId);
    url.searchParams.set("api_key", apiKey);
    url.searchParams.set("file_type", "json");
    url.searchParams.set("sort_order", "asc");
    url.searchParams.set("observation_start", "2019-01-01"); // last ~7 years
    url.searchParams.set("limit", String(limit));

    try{
      const res = await fetch(url.toString(), {signal: controller.signal});
      if (!res.ok) throw new Error(`${seriesId} HTTP ${res.status}`);
      const data = await res.json();
      const obs = (data && data.observations) ? data.observations : [];
      const cleaned = obs
        .filter(o => o && o.value !== "." && o.value !== null && o.date)
        .map(o => ({date:o.date, value:Number(o.value)}))
        .filter(o => isFinite(o.value));

      if (!cleaned.length) throw new Error(`${seriesId} no observations`);
      return cleaned;
    } finally {
      clearTimeout(timeout);
    }
  }

  function buildMetricCard(ind){
    const idSafe = ind.id.replace(/[^a-zA-Z0-9_-]/g,"_");
    const wrap = document.createElement("div");
    wrap.className = "card metric";
    wrap.innerHTML = `
      <h3><a href="https://fred.stlouisfed.org/series/${encodeURIComponent(ind.id)}" target="_blank" rel="noopener">${ind.title}</a></h3>
      <p class="value" id="val-${idSafe}">Loading…</p>
      <div class="meta">
        <span id="date-${idSafe}">—</span>
        <span class="delta flat" id="delta-${idSafe}">—</span>
      </div>
      <div class="chart-wrap">
        <canvas id="ch-${idSafe}" aria-label="${ind.title} chart"></canvas>
        <div class="small" id="err-${idSafe}" style="margin-top:8px;"></div>
      </div>
    `;
    return wrap;
  }

  const charts = new Map();

  function renderChart(canvas, labels, values){
    const ctx = canvas.getContext("2d");
    const existing = charts.get(canvas.id);
    if (existing) existing.destroy();

    const ch = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "",
          data: values,
          pointRadius: 0,
          borderWidth: 2,
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false } },
        scales: {
          x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } },
          y: { ticks: { maxTicksLimit: 5 }, grid: { color: "rgba(148,163,184,.22)" } }
        }
      }
    });

    charts.set(canvas.id, ch);
  }

  function monthLabel(iso){
    // "2026-01-01" -> "Jan 26"
    const d = new Date(iso + "T00:00:00");
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString(undefined, {month:"short", year:"2-digit"});
  }

  function pickChange(series){
    // Prefer YoY if enough history, else last period change
    if (series.length < 2) return {delta: NaN, label:"—"};
    const last = series[series.length - 1].value;
    // Find ~12 periods back if dates are monthly-ish. If not, use previous point.
    const idx = Math.max(0, series.length - 13);
    const prev = series[idx].value;
    const delta = last - prev;
    // If we likely used YoY, label it; else generic chg
    const label = (series.length >= 13) ? "YoY" : "chg";
    return {delta, label};
  }

  async function loadAll(){
    const apiKey = getKey();
    els.conn.textContent = apiKey ? "Yes" : "No";

    // Build cards if not built yet
    for (const s of Object.values(els.sec)) s.innerHTML = "";
    for (const ind of INDICATORS){
      els.sec[ind.section].appendChild(buildMetricCard(ind));
    }

    if (!apiKey){
      // show placeholders
      els.lastUpdated.textContent = "—";
      return;
    }

    // Load headline stats (CPI YoY, UNRATE, DGS10, HOUST)
    // CPI YoY uses CPIAUCSL % change YoY: compute from CPI level series.
    try{
      const [cpi, unemp, teny, starts] = await Promise.all([
        fetchFRED("CPIAUCSL", apiKey, 90),
        fetchFRED("UNRATE", apiKey, 90),
        fetchFRED("DGS10", apiKey, 90),
        fetchFRED("HOUST", apiKey, 90),
      ]);

      // CPI YoY
      const last = cpi[cpi.length-1];
      const prev = cpi[Math.max(0, cpi.length-13)];
      const yoy = (last.value/prev.value - 1) * 100;
      els.statCpi.textContent = yoy.toFixed(1) + "%";

      els.statUnemp.textContent = fmtValue(unemp[unemp.length-1].value, "pct");
      els.stat10y.textContent = fmtValue(teny[teny.length-1].value, "pct");
      els.statStarts.textContent = (Math.round(starts[starts.length-1].value) * 1000).toLocaleString() + " /yr";
    } catch(e){
      // don't hard fail the whole page
      console.warn("Headline stats failed:", e);
    }

    // Load all indicator series and render
    const updatedAt = new Date();
    els.lastUpdated.textContent = updatedAt.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});

    await Promise.all(INDICATORS.map(async (ind) => {
      const idSafe = ind.id.replace(/[^a-zA-Z0-9_-]/g,"_");
      const valEl = document.getElementById(`val-${idSafe}`);
      const dateEl = document.getElementById(`date-${idSafe}`);
      const deltaEl = document.getElementById(`delta-${idSafe}`);
      const errEl = document.getElementById(`err-${idSafe}`);
      const canvas = document.getElementById(`ch-${idSafe}`);

      try{
        errEl.textContent = "";
        const series = await fetchFRED(ind.id, apiKey, 120);
        const last = series[series.length-1];
        valEl.textContent = fmtValue(last.value, ind.fmt);
        dateEl.textContent = monthLabel(last.date);

        const change = pickChange(series);
        const cls = deltaClass(change.delta);
        const arr = arrow(change.delta);

        let deltaText = "—";
        if (isFinite(change.delta)){
          if (ind.fmt === "pct") {
            deltaText = `${arr} ${change.delta.toFixed(2)} pts ${change.label}`;
          } else if (ind.fmt === "usd" || ind.fmt === "index" || ind.fmt === "int") {
            // percent change is more intuitive for these
            const base = series[Math.max(0, series.length-13)].value;
            const pct = base ? ((last.value/base - 1)*100) : NaN;
            if (isFinite(pct)) deltaText = `${arr} ${pct.toFixed(1)}% ${change.label}`;
            else deltaText = `${arr} ${change.delta.toFixed(2)} ${change.label}`;
          } else {
            deltaText = `${arr} ${change.delta.toFixed(2)} ${change.label}`;
          }
        }

        deltaEl.className = `delta ${cls}`;
        deltaEl.textContent = deltaText;

        const labels = series.map(p => monthLabel(p.date));
        const values = series.map(p => p.value);
        renderChart(canvas, labels, values);
      } catch(e){
        console.warn("Indicator failed:", ind.id, e);
        valEl.textContent = "—";
        dateEl.textContent = "—";
        deltaEl.className = "delta flat";
        deltaEl.textContent = "—";
        errEl.innerHTML = `<span class="err">Data unavailable:</span> ${String(e.message || e)}`;
      }
    }));
  }

  // Init controls
    els.conn.textContent = getKey() ? "Yes" : "No";

      if (v) setKey(v);
    els.conn.textContent = getKey() ? "Yes" : "No";
    loadAll();
  });
      clearKey();
    els.conn.textContent = "No";
    loadAll();
  });
  els.refresh.addEventListener("click", () => loadAll());

  // Load on start
  loadAll();
})();
</script>
</body>
</html>
